<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Admin Panel - Paid Members</title>
    <style>
        body { font-family: Arial; background: #f4f4f4; }
        .box { width: 90%; max-width: 900px; background: white; margin: 30px auto; padding: 20px; border-radius: 10px; }
        .login-box { text-align: center; padding: 40px; }
        .login-box input { padding: 10px; width: 100%; max-width: 300px; font-size: 16px; margin: 10px 0; }
        .login-box button { background: #0a63ff; color: white; padding: 10px 30px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        .login-box button:hover { background: #094bd1; }
        .error { color: red; margin: 10px 0; }
        #adminContent { display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border-bottom: 1px solid #ddd; padding: 10px; text-align: left; }
        #downloadBtn {
            display: inline-block;
            background: green;
            padding: 10px 20px;
            color: white;
            margin-top: 10px;
            border-radius: 5px;
            text-decoration: none;
        }
        #logoutBtn {
            display: inline-block;
            background: #ff6b6b;
            padding: 10px 20px;
            color: white;
            margin-top: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        #logoutBtn:hover { background: #ee5a52; }
    </style>
</head>
<body>

<div class="box" id="loginBox">
    <div class="login-box">
        <h2>Admin Access</h2>
        <p>Enter the admin password to access the dashboard.</p>
        <input type="password" id="passwordInput" placeholder="Enter password" />
        <button onclick="authenticate()">Login</button>
        <div id="loginError" class="error"></div>
    </div>
</div>

<div class="box" id="adminContent">
    <h2>Paid Members</h2>
    <button id="logoutBtn" onclick="logout()">Logout</button>
    <p style="color: #666; font-size: 0.9em;">
        <strong>Note:</strong> This admin panel requires the backend API to be deployed. 
        Update the <code>API_URL</code> in the script to point to your live backend.
    </p>

    <a id="downloadBtn" href="#">Download CSV</a>

    <h3 style="margin-top:20px">Upload Gallery Image</h3>
    <h4 style="margin-top:8px">Upload Album (multiple images)</h4>
    <form id="uploadForm" enctype="multipart/form-data">
        <label>Album Title (optional)</label><br>
        <input type="text" id="albumTitle" name="album_title" placeholder="Album title (applies to all images)" style="width:100%;max-width:400px; padding:8px"><br>
        <label>Album Date (optional)</label><br>
        <input type="date" id="albumDate" name="album_date" style="padding:8px"><br>
        <label style="margin-top:8px">Select Images</label><br>
        <input type="file" id="imgFile" name="file" accept="image/*" multiple><br>
        <button type="button" onclick="uploadImage()" style="margin-top:8px">Upload Album</button>
        <div id="uploadStatus" style="margin-top:8px"></div>
    </form>

    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Phone</th>
                <th>Amount (NGN)</th>
            </tr>
        </thead>
        <tbody id="paidTable"></tbody>
    </table>
    <div id="errorMsg" style="color: red; margin-top: 10px;"></div>
</div>

<script src="config.js"></script>
<script>
// ==================== AUTHENTICATION ====================
// IMPORTANT: This is client-side only. For production, use server-side authentication.
// Change this password to something secure. In production, use proper backend auth.
// `config.js` can override `window.ADMIN_PASSWORD`.
const ADMIN_PASSWORD = window.ADMIN_PASSWORD || "admin123";

function authenticate() {
    const passwordInput = document.getElementById("passwordInput").value;
    const loginError = document.getElementById("loginError");

    if (passwordInput === ADMIN_PASSWORD) {
        // Store authentication in session (cleared when browser closes)
        sessionStorage.setItem("adminAuth", "true");
        showAdminPanel();
    } else {
        loginError.innerText = "Incorrect password. Try again.";
    }
}

function logout() {
    sessionStorage.removeItem("adminAuth");
    document.getElementById("loginBox").style.display = "block";
    document.getElementById("adminContent").style.display = "none";
    document.getElementById("passwordInput").value = "";
}

function showAdminPanel() {
    document.getElementById("loginBox").style.display = "none";
    document.getElementById("adminContent").style.display = "block";
    loadPaidMembers();
}

// Check if user is already authenticated (from previous session in same tab)
if (sessionStorage.getItem("adminAuth") === "true") {
    showAdminPanel();
}

// ==================== LOAD DATA ====================
// Configured API URL (set `window.BACKEND_URL` in `config.js` when deploying).
const API_URL = window.BACKEND_URL || 'http://127.0.0.1:5000';

function loadPaidMembers() {
    fetch(`${API_URL}/paid-users`)
        .then(res => {
            if (!res.ok) throw new Error(`Server error: ${res.status}`);
            return res.json();
        })
        .then(data => {
            const table = document.getElementById("paidTable");
            if (!data || data.length === 0) {
                table.innerHTML = '<tr><td colspan="3" style="text-align:center;">No paid members found.</td></tr>';
                return;
            }
            data.forEach(d => {
                table.innerHTML += `
                    <tr>
                        <td>${d.fullname}</td>
                        <td>${d.phone}</td>
                        <td>â‚¦${d.amount}</td>
                    </tr>
                `;
            });

            // Enable CSV download
            const downloadBtn = document.getElementById("downloadBtn");
            downloadBtn.href = `${API_URL}/download-csv`;
            downloadBtn.style.pointerEvents = 'auto';
        })
        .catch(err => {
            const errorDiv = document.getElementById("errorMsg");
            errorDiv.innerText = `Error loading data: ${err.message}. Ensure the backend API is running at ${API_URL}`;
        });
}

// ----------------- IMAGE UPLOAD -----------------
async function uploadImage() {
    const statusEl = document.getElementById('uploadStatus');
    statusEl.innerText = '';
    const fileEl = document.getElementById('imgFile');
    const albumTitle = document.getElementById('albumTitle').value;
    const albumDate = document.getElementById('albumDate').value;
    if (!fileEl.files || fileEl.files.length === 0) { statusEl.innerText = 'Select one or more image files.'; return; }

    const fd = new FormData();
    // append all selected files
    for (let i = 0; i < fileEl.files.length; i++) {
        fd.append('file', fileEl.files[i]);
    }
    if (albumTitle) fd.append('album_title', albumTitle);
    if (albumDate) fd.append('album_date', albumDate);

    try {
        statusEl.innerText = `Uploading ${fileEl.files.length} file(s)...`;
        const resp = await fetch(`${API_URL}/upload-image`, { method: 'POST', body: fd });
        const result = await resp.json();
        if (!resp.ok) { statusEl.innerText = 'Upload failed: ' + (result.message || resp.status); return; }

        // result may contain 'urls' array or single 'url'
        let links = [];
        if (result.urls && Array.isArray(result.urls)) links = result.urls;
        else if (result.url) links = [result.url];

        if (links.length > 0) {
            statusEl.innerHTML = `Uploaded ${links.length} files:` + '<br>' + links.map(u => `<a href="${u}" target="_blank">${u}</a>`).join('<br>');
            // clear form
            document.getElementById('albumTitle').value = '';
            document.getElementById('albumDate').value = '';
            document.getElementById('imgFile').value = '';
        } else {
            statusEl.innerText = 'Upload completed but no file URLs returned.';
        }
    } catch (err) {
        statusEl.innerText = 'Network error: ' + err.message;
    }
}
</script>

</body>
</html>
