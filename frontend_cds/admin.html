<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Admin Panel - Paid Members</title>
    <style>
        body { font-family: Arial; background: #f4f4f4; }
        .box { width: 90%; max-width: 900px; background: white; margin: 30px auto; padding: 20px; border-radius: 10px; }
        .login-box { text-align: center; padding: 40px; }
        .login-box input { padding: 10px; width: 100%; max-width: 300px; font-size: 16px; margin: 10px 0; }
        .login-box button { background: #0a63ff; color: white; padding: 10px 30px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        .login-box button:hover { background: #094bd1; }
        .error { color: red; margin: 10px 0; }
        #adminContent { display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border-bottom: 1px solid #ddd; padding: 10px; text-align: left; }
        #downloadBtn {
            display: inline-block;
            background: green;
            padding: 10px 20px;
            color: white;
            margin-top: 10px;
            border-radius: 5px;
            text-decoration: none;
        }
        #logoutBtn {
            display: inline-block;
            background: #ff6b6b;
            padding: 10px 20px;
            color: white;
            margin-top: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        #logoutBtn:hover { background: #ee5a52; }
    </style>
</head>
<body>

<div class="box" id="loginBox">
    <div class="login-box">
        <h2>Admin Access</h2>
        <p>Enter the admin password to access the dashboard.</p>
        <input type="password" id="passwordInput" placeholder="Enter password" />
        <button onclick="authenticate()">Login</button>
        <div id="loginError" class="error"></div>
    </div>
</div>

<div class="box" id="adminContent">
    <h2>Paid Members</h2>
    <button id="logoutBtn" onclick="logout()">Logout</button>
    <p style="color: #666; font-size: 0.9em;">
    </p>

    <a id="downloadBtn" href="#" onclick="downloadCSV()">Download CSV</a>
    <button id="resetDbBtn" style="background:#ff6b6b;color:#fff;margin-left:12px;padding:10px 14px;border-radius:5px;border:none;cursor:pointer;" onclick="resetDonations()">Reset Donations DB</button>
    
    <h3 style="margin-top:20px">Manage Gallery Images</h3>
    <div id="galleryManagement" style="margin-bottom:20px;">
        <div id="galleryList" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:12px;"></div>
    </div>
    <h3 style="margin-top:20px">Pending Donations</h3>
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Phone</th>
                <th>Amount (NGN)</th>
                <th>Proof</th>
                <th>Bank Acc</th>
                <th>Reference</th>
                <th>Approved By</th>
                <th>Approved At</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="pendingTable"></tbody>
    </table>

    <h3 style="margin-top:20px">Upload Gallery Image</h3>
    <h4 style="margin-top:8px">Upload Album</h4>
    <form id="uploadForm" enctype="multipart/form-data">
    <label>Album Title (optional)</label><br>
    <input
        type="text"
        id="albumTitle"
        name="album_title"
        placeholder="Album title (applies to all images)"
        style="width:100%; max-width:400px; padding:8px"
    /><br>

    <label>Album Date (optional)</label><br>
    <input
        type="date"
        id="albumDate"
        name="album_date"
        style="padding:8px"
    /><br>

    <label style="margin-top:8px">Select Images</label><br>
    <input
        type="file"
        id="imgFile"
        name="file"
        accept="image/*"
        multiple
    /><br>

    <button
        type="button"
        onclick="uploadImage()"
        style="margin-top:8px"
    >
        Upload Album
    </button>

    <div id="uploadStatus" style="margin-top:8px"></div>
    </form>


    <h3 style="margin-top:20px">Manage Bank Accounts</h3>
    <form id="bankForm" onsubmit="event.preventDefault(); addBankAccount();">
        <label>Bank Name</label>
        <input type="text" id="bank_name" placeholder="e.g., First Bank" style="width:100%;max-width:400px; padding:8px" required>
        <label>Account Name</label>
        <input type="text" id="account_name" placeholder="Account holder name" style="width:100%;max-width:400px; padding:8px" required>
        <label>Account Number</label>
        <input type="text" id="account_number" placeholder="e.g., 0123456789" style="width:100%;max-width:400px; padding:8px" required>
        <label>Type</label>
        <input type="text" id="bank_type" placeholder="Savings / Current (optional)" style="width:100%;max-width:400px; padding:8px">
        <button type="submit" style="margin-top:8px">Add / Update Account</button>
    </form>
    <div id="bankList" style="margin-top:12px"></div>

    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Phone</th>
                <th>Amount (NGN)</th>
            </tr>
        </thead>
        <tbody id="paidTable"></tbody>
    </table>
    <div id="errorMsg" style="color: red; margin-top: 10px;"></div>
</div>

<script src="config.js"></script>
<script>
// ==================== AUTHENTICATION ====================
// Now using server-side admin authentication via /admin/login
const ADMIN_PASSWORD = window.ADMIN_PASSWORD || "admin123"; // only used as fallback for older clients
// Configured API URL (set `window.BACKEND_URL` in `config.js` when deploying).
const API_URL = window.BACKEND_URL || 'https://antihiv-aids-cds.onrender.com';
function getToken() {
    return sessionStorage.getItem('adminToken');
}

function isLoggedIn() {
    return sessionStorage.getItem("adminAuth") === "true" && getToken();
}

// ==================== AUTHENTICATION ====================
async function authenticate() {
    const passwordInput = document.getElementById("passwordInput").value;
    const loginError = document.getElementById("loginError");

    try {
        const resp = await fetch(`${API_URL}/admin/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password: passwordInput })
        });

        if (!resp.ok) {
            loginError.innerText = 'Incorrect password. Try again.';
            return;
        }

        const data = await resp.json();

        sessionStorage.setItem('adminAuth', 'true');
        sessionStorage.setItem('adminToken', data.token);

        showAdminPanel();

    } catch (err) {
        // Don't expose error details in console or UI
        loginError.innerText = 'Login failed. Please try again.';
        // Silently log to console (won't help attackers)
    }
}

function logout() {
    sessionStorage.removeItem("adminAuth");
    sessionStorage.removeItem("adminToken");

    document.getElementById("loginBox").style.display = "block";
    document.getElementById("adminContent").style.display = "none";
    document.getElementById("passwordInput").value = "";
}

// ==================== PANEL ====================
function showAdminPanel() {
    document.getElementById("loginBox").style.display = "none";
    document.getElementById("adminContent").style.display = "block";

    loadPendingDonations();
    loadPaidMembers();
    loadBankAccounts();
    loadGalleryImages();
}

// Auto login if still valid in this tab
if (isLoggedIn()) {
    showAdminPanel();
}


// ==================== LOAD DATA ====================



// ------------------- PAID MEMBERS -------------------
function loadPaidMembers() {
    fetch(`${API_URL}/paid-users`)
        .then(res => {
            if (!res.ok) throw new Error(`Server error: ${res.status}`);
            return res.json();
        })
        .then(data => {
            const table = document.getElementById("paidTable");
            table.innerHTML = '';
            if (!data || data.length === 0) {
                table.innerHTML = '<tr><td colspan="3" style="text-align:center;">No paid members found.</td></tr>';
                return;
            }
            data.forEach(d => {
                table.innerHTML += `
                    <tr>
                        <td>${d.fullname}</td>
                        <td>${d.phone}</td>
                        <td>₦${d.amount}</td>
                    </tr>
                `;
            });

            // Enable CSV download
          const downloadBtn = document.getElementById("downloadBtn");

            downloadBtn.onclick = async (e) => {
                e.preventDefault();

                const token = getToken();
                if (!token) {
                    alert("Not authenticated");
                    return;
                }

                try {
                    const res = await fetch(`${API_URL}/download-csv`, {
                        method: 'GET',
                        headers: {
                            'Authorization': 'Bearer ' + token
                        }
                    });

                    if (!res.ok) {
                        const text = await res.text();
                        throw new Error(`HTTP ${res.status}: ${text}`);
                    }

                    const blob = await res.blob();
                    const url = window.URL.createObjectURL(blob);

                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'donations.csv';
                    document.body.appendChild(a);
                    a.click();
                    a.remove();

                    window.URL.revokeObjectURL(url);
                } catch (err) {
                    alert('CSV download failed: ' + err.message);
                }
            };
        })
        .catch(err => {
            const errorDiv = document.getElementById("errorMsg");
            errorDiv.innerText = `Error loading data: ${err.message}. Ensure the backend API is running at ${API_URL}`;
        });
}

// ------------------- PENDING DONATIONS -------------------
function loadPendingDonations() {
  
    const token = sessionStorage.getItem('adminToken');
    if (!token) { document.getElementById('errorMsg').innerText = 'Not authenticated'; return; }
     fetch(`${API_URL}/pending-donations`, { headers: { 'Authorization': 'Bearer ' + token } })
        .then(res => {
            if (!res.ok) throw new Error(`Server error: ${res.status}`);
            return res.json();
        })
        .then(data => {
            const table = document.getElementById('pendingTable');
            table.innerHTML = '';
            if (!data || data.length === 0) {
                table.innerHTML = '<tr><td colspan="6" style="text-align:center;">No pending donations.</td></tr>';
                return;
            }
            data.forEach(d => {
                const tokenParam = token ? `?token=${encodeURIComponent(token)}` : '';
                const proofCell = d.proof_filename ? `<a href="${API_URL}/protected-proof/${d.proof_filename}${tokenParam}" target="_blank">View</a>` : '—';
                table.innerHTML += `
                    <tr>
                        <td>${d.fullname}</td>
                        <td>${d.phone}</td>
                        <td>₦${d.amount}</td>
                        <td>${proofCell}</td>
                        <td>${d.bank_account_id || '—'}</td>
                        <td>${d.reference}</td>
                        <td>${d.approved_by || '—'}</td>
                        <td>${d.approved_at || '—'}</td>
                        <td><button id="btn_${d.reference}" onclick="validateDonation(this, '${d.reference}')">Mark Paid</button></td>
                    </tr>
                `;
            });
        })
        .catch(err => {
            const errorDiv = document.getElementById("errorMsg");
            errorDiv.innerText = `Error loading pending donations: ${err.message}.`;
        });
}

function validateDonation(btn, reference) {
    // Prevent duplicate clicks
    try { btn.disabled = true; btn.innerText = 'Processing...'; } catch (e) {}
    const token = sessionStorage.getItem('adminToken');
    if (!token) { alert('Not authenticated'); btn.disabled = false; btn.innerText = 'Mark Paid'; return; }
    fetch(`${API_URL}/admin/validate-donation`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
        body: JSON.stringify({ reference })
    }).then(res => {
        if (!res.ok) return res.text().then(t => { throw new Error(t || res.status); });
        return res.json();
    }).then(() => {
        loadPendingDonations();
        loadPaidMembers();
    }).catch(err => {
        const errorDiv = document.getElementById("errorMsg");
        errorDiv.innerText = `Error validating donation: ${err.message}`;
    }).finally(() => {
        // re-enable (in case of failure) or keep disabled (button will be removed on reload)
        try { btn.disabled = false; btn.innerText = 'Mark Paid'; } catch (e) {}
    });
}

// ----------------- IMAGE UPLOAD -----------------
async function uploadImage() {
    const statusEl = document.getElementById('uploadStatus');
    statusEl.innerText = '';
    const fileEl = document.getElementById('imgFile');
    const albumTitle = document.getElementById('albumTitle').value;
    const albumDate = document.getElementById('albumDate').value;
    if (!fileEl.files || fileEl.files.length === 0) { statusEl.innerText = 'Select one or more image files.'; return; }

    const fd = new FormData();
    // append all selected files
    for (let i = 0; i < fileEl.files.length; i++) {
        fd.append('file', fileEl.files[i]);
    }
    if (albumTitle) fd.append('album_title', albumTitle);
    if (albumDate) fd.append('album_date', albumDate);

    try {
        statusEl.innerText = `Uploading ${fileEl.files.length} file(s)...`;
        const resp = await fetch(`${API_URL}/upload-image`, { method: 'POST', body: fd });
        const text = await resp.text();

        let result;
        try {
            result = JSON.parse(text);
        } catch (e) {
            statusEl.innerText = 'Server error (not JSON):\n' + text.slice(0, 200);
            return;
}
        if (!resp.ok) { 
            statusEl.innerText = 'Upload failed: ' + (result.message || resp.status);
             return; }

        // result may contain 'urls' array or single 'url'
        let links = [];
        if (result.urls && Array.isArray(result.urls)) links = result.urls;
        else if (result.url) links = [result.url];

        if (links.length > 0) {
            statusEl.innerHTML = `Uploaded ${links.length} files:` + '<br>' + links.map(u => `<a href="${u}" target="_blank">${u}</a>`).join('<br>');
            // clear form
            document.getElementById('albumTitle').value = '';
            document.getElementById('albumDate').value = '';
            document.getElementById('imgFile').value = '';
        } else {
            statusEl.innerText = 'Upload completed but no file URLs returned.';
        }
    } catch (err) {
        statusEl.innerText = 'Network error: ' + err.message;
    }
}

// --------- RESET DB -------------
function resetDonations() {
    fetch(`${API_URL}/admin/reset-donations`, {
    method: 'POST',
    headers: {
        'Authorization': 'Bearer ' + getToken()
    }
})
.then(res => {
    if (!res.ok) {
        return res.text().then(t => {
            throw new Error(`HTTP ${res.status}: ${t.slice(0, 100)}`);
        });
    }
    return res.json();
})
.then(j => {
    alert(`Reset complete. deleted_rows: ${j.deleted_rows || 0}, deleted_files: ${j.deleted_files || 0}`);
    loadPendingDonations();
    loadPaidMembers();
    loadBankAccounts();
})
.catch(err => {
    alert('Reset failed: ' + err.message);
})
.finally(() => {
    btn.disabled = false;
    btn.innerText = 'Reset Donations DB';
});
}

// ----------------- BANK ACCOUNTS (ADMIN) -----------------
async function loadBankAccounts() {
    const token = sessionStorage.getItem('adminToken');
    const listEl = document.getElementById('bankList');
    listEl.innerText = 'Loading...';
    if (!token) { listEl.innerText = 'Not authenticated'; return; }
    try {
        // Prefer Authorization header; fallback to query token if unauthorized (helps avoid extra preflight problems)
        const headers = token ? { 'Authorization': 'Bearer ' + token } : {};
        let resp = await fetch(`${API_URL}/admin/bank-accounts`, { headers });
        if (resp.status === 401 && token) {
            // fallback to query token for older clients
            resp = await fetch(`${API_URL}/admin/bank-accounts?token=${encodeURIComponent(token)}`);
        }
        if (!resp.ok) throw new Error('Failed to load');
        const data = await resp.json();
        if (!data || data.length === 0) { listEl.innerHTML = '<em>No bank accounts configured.</em>'; return; }
        listEl.innerHTML = data.map(a => `
            <div style="padding:8px;border:1px solid #eee;margin-bottom:8px;border-radius:6px;">
                <strong>${a.bank_name}</strong> — ${a.account_name} — ${a.account_number} ${a.bank_type? '('+a.bank_type+')':''}
                <div style="margin-top:8px;">
                    <button onclick="deleteBank(${a.id})" style="background:#ff6b6b;color:white;border:none;padding:6px 10px;border-radius:6px;">Delete</button>
                    <button onclick="toggleActive(${a.id}, ${a.active ? 0 : 1})" style="margin-left:8px;">${a.active ? 'Disable' : 'Enable'}</button>
                </div>
            </div>`).join('\n');
    } catch (err) {
        listEl.innerText = 'Error loading bank accounts: ' + err.message;
    }
}

async function addBankAccount() {
    const token = sessionStorage.getItem('adminToken');
    if (!token) { alert('Not authenticated'); return; }
    const bank_name = document.getElementById('bank_name').value.trim();
    const account_name = document.getElementById('account_name').value.trim();
    const account_number = document.getElementById('account_number').value.trim();
    const bank_type = document.getElementById('bank_type').value.trim();
    if (!bank_name || !account_name || !account_number) { alert('All required fields'); return; }
    try {
        // Prefer Authorization header when available
        const params = new URLSearchParams({ bank_name, account_name, account_number, bank_type });
        const headers = token ? { 'Authorization': 'Bearer ' + token } : {};
        // If header is used, some browsers will preflight; server allows Authorization header.
        let resp = await fetch(`${API_URL}/admin/bank-accounts`, { method: 'POST', body: params, headers });
        if (resp.status === 401 && token) {
            // fallback to query token if header fails
            resp = await fetch(`${API_URL}/admin/bank-accounts?token=${encodeURIComponent(token)}`, { method: 'POST', body: params });
        }
        if (!resp.ok) {
            // try to extract error body
            let body = '';
            try { body = await resp.json(); } catch(e) { try { body = await resp.text(); } catch(e2){ body = '' } }
            const msg = (body && body.message) ? body.message : (typeof body === 'string' && body) ? body : `Status ${resp.status}`;
            throw new Error(msg);
        }
        document.getElementById('bank_name').value = '';
        document.getElementById('account_name').value = '';
        document.getElementById('account_number').value = '';
        document.getElementById('bank_type').value = '';
        loadBankAccounts();
    } catch (err) { alert('Add failed: ' + err.message); }
}
 //Example delete button for an image with ID stored in a variable `imageId` 
  async function deleteImage(imageId) {
    if (!confirm('Delete this image?')) return;
    
    const token = sessionStorage.getItem('adminToken');

    if (!token) {
      alert("Please login as admin first.");
      return;
    }

    try {
      const res = await fetch(`${API_URL}/admin/delete-image/${imageId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      if (res.ok) {
        alert('Image deleted successfully.');
        loadGalleryImages();
      } else {
        const error = await res.json();
        alert('Delete failed: ' + (error.message || res.statusText));
      }
    } catch (e) {
      alert('Network error: ' + e.message);
    }
  }

// Load gallery images for management
async function loadGalleryImages() {
    const container = document.getElementById('galleryList');
    container.innerHTML = 'Loading gallery...';
    
    try {
        const res = await fetch(`${API_URL}/gallery`);
        if (!res.ok) throw new Error(`Server error: ${res.status}`);
        
        const images = await res.json();
        
        if (!images || images.length === 0) {
            container.innerHTML = '<p>No images in gallery yet.</p>';
            return;
        }
        
        container.innerHTML = images.map(img => `
            <div id="image-${img.id}" style="border:1px solid #ddd;border-radius:8px;overflow:hidden;background:#f9f9f9;">
                <img src="${img.url}" alt="${img.title || 'Gallery'}" style="width:100%;height:120px;object-fit:cover;display:block;">
                <div style="padding:8px;font-size:0.85rem;">
                    <div><strong>${img.title || 'Untitled'}</strong></div>
                    <div style="color:#666;font-size:0.8rem;margin:4px 0;">${img.taken_at ? new Date(img.taken_at).toLocaleDateString() : 'No date'}</div>
                    <button onclick="deleteImage(${img.id})" style="width:100%;background:#ff6b6b;color:white;border:none;padding:6px;border-radius:4px;cursor:pointer;margin-top:4px;">Delete</button>
                </div>
            </div>
        `).join('');
    } catch (err) {
        container.innerHTML = 'Error loading gallery: ' + err.message;
    }
}


async function deleteBank(id) {
    if (!confirm('Delete this bank account?')) return;
    const token = sessionStorage.getItem('adminToken');
    if (!token) { alert('Not authenticated'); return; }
    try {
        // Prefer Authorization header for delete; fallback to query token
        const headers = token ? { 'Authorization': 'Bearer ' + token } : {};
        let resp = await fetch(`${API_URL}/admin/bank-accounts/${id}`, { method: 'DELETE', headers });
        if (resp.status === 401 && token) {
            resp = await fetch(`${API_URL}/admin/bank-accounts/${id}?token=${encodeURIComponent(token)}`, { method: 'DELETE' });
        }
        if (!resp.ok) {
            let body = '';
            try { body = await resp.json(); } catch(e) { try { body = await resp.text(); } catch(e2){ body = '' } }
            const msg = (body && body.message) ? body.message : `Status ${resp.status}`;
            throw new Error(msg);
        }
        loadBankAccounts();
    } catch (err) { alert(err.message); }
}

async function toggleActive(id, activeValue) {
    const token = sessionStorage.getItem('adminToken');
    if (!token) { alert('Not authenticated'); return; }
    try {
        // Prefer Authorization header; fallback to query token when necessary
        const params = new URLSearchParams({ active: !!activeValue });
        const headers = token ? { 'Authorization': 'Bearer ' + token } : {};
        let resp = await fetch(`${API_URL}/admin/bank-accounts/${id}`, { method: 'PUT', body: params, headers });
        if (resp.status === 401 && token) {
            resp = await fetch(`${API_URL}/admin/bank-accounts/${id}?token=${encodeURIComponent(token)}`, { method: 'PUT', body: params });
        }
        if (!resp.ok) {
            let body = '';
            try { body = await resp.json(); } catch(e) { try { body = await resp.text(); } catch(e2){ body = '' } }
            const msg = (body && body.message) ? body.message : `Status ${resp.status}`;
            throw new Error(msg);
        }
        loadBankAccounts();
    } catch (err) { alert(err.message); }
}
</script>

</body>
</html>
